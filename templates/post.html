<!DOCTYPE html>
<html lang="{{language.locale}}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{title}}</title>
    {{#if seoKeywords.length}}
    <meta name="keywords" content="{{#each seoKeywords}}{{this}}{{#unless @last}}, {{/unless}}{{/each}}">
    {{/if}}
    {{#if metaDescription}}
    <meta name="description" content="{{metaDescription}}">
    {{else}}
    <meta name="description" content="{{site.description}}">
    {{/if}}
    <link rel="stylesheet" href="/styles/modern.css">
    <link rel="alternate" type="application/rss+xml" title="{{site.title}} RSS Feed" href="{{assets.rss}}">
    <link rel="sitemap" type="application/xml" title="Sitemap" href="{{assets.sitemap}}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css" data-theme-style="light">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css" data-theme-style="dark" disabled>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {{{json theme.tailwind}}};
    </script>
    <script>
      window.__I18N__ = {{{json clientTranslations}}};
      window.__ASSETS__ = {{{json assets}}};
    </script>
    {{#if analytics.head}}
    {{{analytics.head}}}
    {{/if}}
</head>
<body class="{{theme.bodyClass}} theme-light antialiased">
    <header class="navbar {{#if navigation.isSticky}}navbar-sticky{{else}}navbar-static{{/if}}">
        <div class="navbar-container">
            <div class="navbar-brand">
                <a href="{{navigation.homeUrl}}" class="navbar-logo">{{site.title}}</a>
            </div>
            <div class="navbar-right">
                <nav class="navbar-menu" id="navbar-menu">
                    <div class="navbar-mobile-panel">
                        <div class="navbar-mobile-actions">
                            <button type="button" class="nav-icon-button" data-filter-open aria-haspopup="dialog" aria-expanded="false" aria-controls="post-filter-modal" aria-label="{{navigation.filterLabel}}">
                                <span class="sr-only">{{navigation.filterLabel}}</span>
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M12.323 13.383a5.5 5.5 0 1 1 1.06-1.06l2.897 2.897a.75.75 0 1 1-1.06 1.06l-2.897-2.897Zm.677-4.383a4 4 0 1 1-8 0 4 4 0 0 1 8 0Z"/></svg>
                            </button>
                            <a href="{{assets.rss}}" class="nav-icon-button nav-mobile-rss" target="_blank" rel="noopener noreferrer" aria-label="{{t 'nav.rss'}}">
                                <span aria-hidden="true">RSS</span>
                            </a>
                            <button type="button" class="theme-toggle nav-mobile-theme" data-theme-toggle aria-label="{{t 'theme.toggleDark'}}" data-theme-label-dark="{{t 'theme.toggleDark'}}" data-theme-label-light="{{t 'theme.toggleLight'}}">
                                <span class="theme-toggle-icon" data-theme-icon>üåô</span>
                            </button>
                        </div>
                    </div>
                    <div class="navbar-nav">
                        <a href="{{navigation.homeUrl}}" class="nav-item {{#if (eq navigation.activePage 'home')}}active{{/if}}">
                            <span class="nav-text">{{t 'nav.home'}}</span>
                        </a>
                        {{#if navigation.categories.hasCategories}}
                            {{#each navigation.categories.primary}}
                                <a href="{{url}}" class="nav-item {{#if (eq slug ../navigation.activeCategorySlug)}}active{{/if}}">
                                    <span class="nav-text">{{name}}</span>
                                </a>
                            {{/each}}
                            {{#if navigation.categories.more.length}}
                                <div class="nav-item nav-dropdown">
                                    <button type="button" class="nav-dropdown-toggle" aria-expanded="false">
                                        <span class="nav-text">{{navigation.categories.moreLabel}}</span>
                                        <span class="nav-dropdown-icon">‚ñæ</span>
                                    </button>
                                    <div class="nav-dropdown-menu" hidden>
                                        {{#each navigation.categories.more}}
                                            <a href="{{url}}" class="nav-dropdown-item {{#if (eq slug ../../navigation.activeCategorySlug)}}active{{/if}}">{{name}}</a>
                                        {{/each}}
                                    </div>
                                </div>
                            {{/if}}
                        {{/if}}
                        <a href="{{navigation.aboutUrl}}" class="nav-item {{#if (eq navigation.activePage 'about')}}active{{/if}}">
                            <span class="nav-text">{{t 'nav.about'}}</span>
                        </a>
                        <a href="{{assets.rss}}" class="nav-item nav-item-special" target="_blank" rel="noopener noreferrer">
                            <span class="nav-text">{{t 'nav.rss'}}</span>
                        </a>
                    </div>
                </nav>
                {{#if navigation.hasLanguageSwitcher}}
                <div class="navbar-languages" aria-label="{{t 'nav.language'}}">
                    {{#each navigation.languages}}
                        <a href="{{url}}" class="nav-item nav-item-language {{#if active}}active{{/if}}">{{label}}</a>
                    {{/each}}
                </div>
                {{/if}}
                <div class="navbar-actions">
                    <button type="button" class="nav-icon-button" id="post-filter-open" data-filter-open aria-haspopup="dialog" aria-expanded="false" aria-controls="post-filter-modal" aria-label="{{navigation.filterLabel}}">
                        <span class="sr-only">{{navigation.filterLabel}}</span>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M12.323 13.383a5.5 5.5 0 1 1 1.06-1.06l2.897 2.897a.75.75 0 1 1-1.06 1.06l-2.897-2.897Zm.677-4.383a4 4 0 1 1-8 0 4 4 0 0 1 8 0Z"/></svg>
                    </button>
                    <button type="button" class="theme-toggle" data-theme-toggle aria-label="{{t 'theme.toggleDark'}}" data-theme-label-dark="{{t 'theme.toggleDark'}}" data-theme-label-light="{{t 'theme.toggleLight'}}">
                        <span class="theme-toggle-icon" data-theme-icon>üåô</span>
                    </button>
                </div>
            </div>
            <button class="navbar-toggle" id="navbar-toggle" aria-label="{{navigation.toggleMenuLabel}}">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </header>
    <div class="filter-modal" id="post-filter-modal" hidden>
        <div class="filter-modal-backdrop" data-filter-dismiss></div>
        <div class="filter-modal-dialog" role="dialog" aria-modal="true" aria-labelledby="post-filter-title">
            <div class="filter-modal-content">
                <div class="filter-modal-header">
                    <h2 id="post-filter-title">{{t 'filters.title'}}</h2>
                    <button type="button" class="filter-modal-close" data-filter-dismiss aria-label="{{t 'buttons.closeFilter'}}">
                        <span aria-hidden="true">√ó</span>
                    </button>
                </div>
                <div class="filter-modal-body">
                    <section class="post-filters" aria-label="{{t 'filters.sectionLabel'}}">
                        <div class="search-field">
                            <span class="search-icon" aria-hidden="true">üîç</span>
                            <input type="search" id="post-search" class="search-input" placeholder="{{t 'filters.searchPlaceholder'}}" autocomplete="off" spellcheck="false">
                        </div>
                        {{#if hasTagFilters}}
                        <div class="tag-filter" id="tag-filter" role="list">
                            <button type="button" class="tag-filter-btn active" data-tag="">{{t 'filters.allTags'}}</button>
                            {{#each availableTags}}
                            <button type="button" class="tag-filter-btn" data-tag="{{name}}">{{name}}</button>
                            {{/each}}
                        </div>
                        {{/if}}
                    </section>
                    <div class="filter-modal-results" data-modal-results hidden></div>
                </div>
            </div>
        </div>
    </div>
    <main class="mx-0 px-4 sm:px-6 lg:px-8 py-4">
        <article class="article-container{{#if coverImage}} has-cover{{/if}}">
            <div class="article-header">
                <h1 class="article-title">{{title}}</h1>
                <div class="article-meta">
                    <div class="article-meta-date">
                        <time datetime="{{dateISO}}">{{dateFormatted}}</time>
                    </div>
                    <div class="article-meta-chips">
                        {{#if category}}
                        <a href="{{category.url}}" class="post-chip post-chip-category">{{category.name}}</a>
                        {{/if}}
                        {{#if tags}}
                        {{#each tags}}
                        <a href="{{url}}" class="post-chip">{{name}}</a>
                        {{/each}}
                        {{/if}}
                    </div>
                </div>
                {{#if coverImage}}
                <div class="article-cover">
                    <img src="{{coverImage}}" alt="{{title}}" class="article-cover-image" loading="lazy" onerror="this.onerror=null;this.src='/assets/placeholder.svg';this.classList.add('placeholder');">
                </div>
                {{/if}}
            </div>
            <div class="article-content">
                {{{content}}}
            </div>
            {{#if hasRecommendations}}
            <aside class="article-recommendations" aria-label="{{t 'recommendations.aria'}}">
                <h2 class="recommendations-title">{{t 'recommendations.title'}}</h2>
                <div class="recommendations-grid">
                    {{#each recommendedPosts}}
                    <article class="recommendation-card">
                        {{#if coverImage}}
                        <a href="{{url}}" class="recommendation-media">
                            <img src="{{coverImage}}" alt="{{title}}" loading="lazy" onerror="this.onerror=null;this.src='/assets/placeholder.svg';this.classList.add('placeholder');">
                        </a>
                        {{/if}}
                        <div class="recommendation-content">
                            <h3><a href="{{url}}">{{title}}</a></h3>
                            <div class="recommendation-meta">
                                <time datetime="{{dateISO}}">{{dateFormatted}}</time>
                            </div>
                        </div>
                    </article>
                    {{/each}}
                </div>
            </aside>
            {{/if}}
        </article>
    </main>
    <footer class="footer">
        <div class="footer-inner {{#unless footer.social.length}}{{#unless footer.external.length}}footer-centered{{/unless}}{{/unless}}">
            {{#if footer.external.length}}
            <nav class="footer-links-row" aria-label="External links">
                {{#each footer.external}}
                <a href="{{url}}" class="footer-link-chip" target="_blank" rel="noopener noreferrer">
                    <span class="footer-link-label">{{label}}</span>
                    {{#if description}}
                    <span class="footer-link-desc">{{description}}</span>
                    {{/if}}
                </a>
                {{/each}}
            </nav>
            {{/if}}
            {{#if footer.social.length}}
            <div class="footer-social" aria-label="Social links">
                {{#each footer.social}}
                <a href="{{url}}" class="footer-social-link" target="_blank" rel="noopener noreferrer" aria-label="{{#if label}}{{label}}{{else}}{{url}}{{/if}}">
                    {{#if icon}}
                    <span class="footer-social-icon">{{{icon}}}</span>
                    {{else}}
                    <span class="footer-social-fallback">{{fallback}}</span>
                    {{/if}}
                    {{#if label}}<span class="sr-only">{{label}}</span>{{/if}}
                </a>
                {{/each}}
            </div>
            {{/if}}
            <div class="footer-meta">
                <p class="footer-copy">&copy; {{site.copyrightYear}} {{site.title}}. All rights reserved.</p>
                {{#if footer.icp.text}}
                <p class="footer-icp">
                    {{#if footer.icp.link}}
                    <a href="{{footer.icp.link}}" target="_blank" rel="noopener noreferrer">{{footer.icp.text}}</a>
                    {{else}}
                    {{footer.icp.text}}
                    {{/if}}
                </p>
                {{/if}}
                {{#if footer.note}}
                <p class="footer-note">{{footer.note}}</p>
                {{/if}}
            </div>
        </div>
    </footer>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const translations = window.__I18N__ || {};
            const assets = window.__ASSETS__ || {};
            const SEARCH_INDEX_URL = assets.search || '/search.json';
            const getTranslation = (source, path) => {
                return path.split('.').reduce((acc, part) => (acc && acc[part] !== undefined ? acc[part] : undefined), source);
            };
            const t = (key, fallback) => {
                const value = getTranslation(translations, key);
                return typeof value === 'string' ? value : fallback;
            };
            const copyLabel = t('buttons.copy', 'Â§çÂà∂');
            const copySuccessLabel = t('buttons.copySuccess', 'Â∑≤Â§çÂà∂');
            const copyCodeLabel = t('buttons.copyCode', 'Â§çÂà∂‰ª£Á†Å');
            const themeLabelDark = t('theme.toggleDark', 'ÂàáÊç¢‰∏∫ÊöóËâ≤Ê®°Âºè');
            const themeLabelLight = t('theme.toggleLight', 'ÂàáÊç¢‰∏∫‰∫ÆËâ≤Ê®°Âºè');
            const searchErrorMessage = t('messages.searchError', 'ÊêúÁ¥¢Á¥¢ÂºïÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÂÜçËØï„ÄÇ');
            const searchEmptyMessage = t('messages.searchNoResults', 'Ê≤°ÊúâÊâæÂà∞ÂåπÈÖçÁöÑÊñáÁ´†„ÄÇ');
            document.querySelectorAll('img').forEach(img => {
                img.addEventListener('error', function() {
                    if (this.dataset.fallbackApplied) return;
                    this.dataset.fallbackApplied = '1';
                    this.src = '/assets/placeholder.png';
                    this.classList.add('placeholder');
                }, { once: true });
            });
            document.querySelectorAll('.copy-code-btn').forEach(btn => {
                btn.textContent = copyLabel;
                btn.dataset.originalLabel = copyLabel;
                btn.setAttribute('aria-label', copyCodeLabel);
            });

            const navbarToggle = document.getElementById('navbar-toggle');
            const navbarMenu = document.getElementById('navbar-menu');
            const mobileNavQuery = window.matchMedia('(max-width: 768px)');
            const addMediaQueryListener = (mql, handler) => {
                if (typeof mql.addEventListener === 'function') {
                    mql.addEventListener('change', handler);
                } else if (typeof mql.addListener === 'function') {
                    mql.addListener(handler);
                }
            };

            if (navbarToggle && navbarMenu) {
                navbarToggle.addEventListener('click', function() {
                    navbarToggle.classList.toggle('open');
                    navbarMenu.classList.toggle('open');
                    document.body.classList.toggle('nav-open', navbarMenu.classList.contains('open'));
                });

                const navLinks = navbarMenu.querySelectorAll('a.nav-item, .nav-dropdown-item');
                navLinks.forEach(link => {
                    link.addEventListener('click', function() {
                        if (!navbarMenu.classList.contains('open')) return;
                        navbarToggle.classList.remove('open');
                        navbarMenu.classList.remove('open');
                        document.body.classList.remove('nav-open');
                    });
                });

                document.addEventListener('click', function(e) {
                    if (!navbarToggle.contains(e.target) && !navbarMenu.contains(e.target)) {
                        navbarToggle.classList.remove('open');
                        navbarMenu.classList.remove('open');
                        document.body.classList.remove('nav-open');
                    }
                });
            }

            const dropdowns = Array.from(document.querySelectorAll('.nav-dropdown'));
            const dropdownControllers = [];

            dropdowns.forEach(dropdown => {
                const toggle = dropdown.querySelector('.nav-dropdown-toggle');
                const menu = dropdown.querySelector('.nav-dropdown-menu');
                if (!toggle || !menu) return;

                const clearTransition = () => {
                    if (menu._dropdownTransitionHandler) {
                        menu.removeEventListener('transitionend', menu._dropdownTransitionHandler);
                        menu._dropdownTransitionHandler = null;
                    }
                };

                const setDropdownState = (open, immediate = false) => {
                    const alreadyOpen = toggle.getAttribute('aria-expanded') === 'true';
                    if (open === alreadyOpen && !immediate) return;

                    clearTransition();
                    toggle.setAttribute('aria-expanded', String(open));

                    if (!mobileNavQuery.matches || immediate) {
                        menu.hidden = !open;
                        menu.classList.toggle('is-open', open);
                        menu.style.maxHeight = '';
                        return;
                    }

                    if (open) {
                        menu.hidden = false;
                        menu.classList.add('is-open');
                        menu.style.maxHeight = '0px';
                        requestAnimationFrame(() => {
                            menu.style.maxHeight = `${menu.scrollHeight}px`;
                        });
                        const handleOpenEnd = (event) => {
                            if (event.propertyName !== 'max-height') return;
                            menu.style.maxHeight = 'none';
                            menu.removeEventListener('transitionend', handleOpenEnd);
                            menu._dropdownTransitionHandler = null;
                        };
                        menu._dropdownTransitionHandler = handleOpenEnd;
                        menu.addEventListener('transitionend', handleOpenEnd);
                    } else {
                        if (menu.hidden && !menu.classList.contains('is-open')) {
                            menu.style.maxHeight = '';
                            return;
                        }
                        const height = menu.scrollHeight;
                        menu.style.maxHeight = `${height}px`;
                        requestAnimationFrame(() => {
                            menu.classList.remove('is-open');
                            menu.style.maxHeight = '0px';
                        });
                        const handleCloseEnd = (event) => {
                            if (event.propertyName !== 'max-height') return;
                            menu.hidden = true;
                            menu.style.maxHeight = '';
                            menu.removeEventListener('transitionend', handleCloseEnd);
                            menu._dropdownTransitionHandler = null;
                        };
                        menu._dropdownTransitionHandler = handleCloseEnd;
                        menu.addEventListener('transitionend', handleCloseEnd);
                    }
                };

                toggle.addEventListener('click', (event) => {
                    event.preventDefault();
                    const expanded = toggle.getAttribute('aria-expanded') === 'true';
                    setDropdownState(!expanded);
                });

                document.addEventListener('click', (event) => {
                    if (!dropdown.contains(event.target)) {
                        setDropdownState(false);
                    }
                });

                dropdownControllers.push({ setState: setDropdownState });
            });

            addMediaQueryListener(mobileNavQuery, () => {
                dropdownControllers.forEach(({ setState }) => setState(false, true));
            });

            document.body.addEventListener('click', async (e) => {
                const btn = e.target.closest('.copy-code-btn');
                if (!btn) return;
                const container = btn.closest('.code-block');
                if (!container) return;
                const codeEl = container.querySelector('pre code');
                if (!codeEl) return;
                const text = codeEl.innerText;
                try {
                    await navigator.clipboard.writeText(text);
                    const original = btn.dataset.originalLabel || copyLabel;
                    btn.textContent = copySuccessLabel;
                    btn.classList.add('copied');
                    setTimeout(() => {
                        btn.textContent = original;
                        btn.classList.remove('copied');
                    }, 1200);
                } catch (err) {
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    document.body.appendChild(textarea);
                    textarea.select();
                    try { document.execCommand('copy'); } catch {}
                    document.body.removeChild(textarea);
                    const original = btn.dataset.originalLabel || copyLabel;
                    btn.textContent = copySuccessLabel;
                    btn.classList.add('copied');
                    setTimeout(() => {
                        btn.textContent = original;
                        btn.classList.remove('copied');
                    }, 1200);
                }
            });

            const themeToggleButtons = document.querySelectorAll('[data-theme-toggle]');
            const highlightThemeLinks = document.querySelectorAll('link[data-theme-style]');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');

            themeToggleButtons.forEach(button => {
                button.dataset.themeLabelDark = button.getAttribute('data-theme-label-dark') || themeLabelDark;
                button.dataset.themeLabelLight = button.getAttribute('data-theme-label-light') || themeLabelLight;
            });

            const updateHighlightThemes = (isDark) => {
                highlightThemeLinks.forEach(link => {
                    const themeStyle = link.getAttribute('data-theme-style');
                    if (!themeStyle) return;
                    if (themeStyle === 'dark') {
                        link.disabled = !isDark;
                    } else {
                        link.disabled = isDark;
                    }
                });
            };

            const applyTheme = (theme, persist = true) => {
                const isDark = theme === 'dark';
                document.body.classList.toggle('theme-dark', isDark);
                document.body.classList.toggle('theme-light', !isDark);
                document.body.setAttribute('data-theme', theme);
                themeToggleButtons.forEach(button => {
                    const icon = button.querySelector('[data-theme-icon]');
                    if (icon) {
                        icon.textContent = isDark ? 'üåû' : 'üåô';
                    }
                    const dark = button.dataset.themeLabelDark || themeLabelDark;
                    const light = button.dataset.themeLabelLight || themeLabelLight;
                    button.setAttribute('aria-label', isDark ? light : dark);
                });
                updateHighlightThemes(isDark);
                if (persist) {
                    localStorage.setItem('theme', theme);
                }
            };

            const storedTheme = localStorage.getItem('theme');
            if (storedTheme) {
                applyTheme(storedTheme, false);
            } else {
                applyTheme(prefersDark.matches ? 'dark' : 'light', false);
            }

            themeToggleButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const nextTheme = document.body.classList.contains('theme-dark') ? 'light' : 'dark';
                    applyTheme(nextTheme, true);
                });
            });

            prefersDark.addEventListener('change', (event) => {
                if (!localStorage.getItem('theme')) {
                    applyTheme(event.matches ? 'dark' : 'light', false);
                }
            });

            const searchInput = document.getElementById('post-search');
            const tagFilter = document.getElementById('tag-filter');
            const modalResultsContainer = document.querySelector('[data-modal-results]');
            const filterOpenButtons = document.querySelectorAll('[data-filter-open]');
            const filterModal = document.getElementById('post-filter-modal');
            const filterDialog = filterModal ? filterModal.querySelector('.filter-modal-dialog') : null;
            const modalDismissElements = filterModal ? filterModal.querySelectorAll('[data-filter-dismiss]') : [];
            const resultsContainer = modalResultsContainer;
            const useModalResults = true;
            let lastFocusedElement = null;
            let modalVisible = false;

            const activeTags = new Set();
            let searchTerm = '';
            let searchIndex = [];

            const escapeHtml = (value) => {
                return String(value || '')
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            };

            const updateFilterButtonExpanded = (expanded) => {
                filterOpenButtons.forEach(button => {
                    button.setAttribute('aria-expanded', String(expanded));
                    button.classList.toggle('is-open', expanded);
                });
            };

            const updateFilterButtonActive = (active) => {
                filterOpenButtons.forEach(button => {
                    button.classList.toggle('active', active);
                });
            };

            const ensureSearchIndex = async () => {
                if (searchIndex.length) return;
                try {
                    const response = await fetch(SEARCH_INDEX_URL);
                    if (!response.ok) throw new Error('Failed to load search index');
                    const payload = await response.json();
                    searchIndex = Array.isArray(payload.posts) ? payload.posts : [];
                } catch (err) {
                    console.error(err);
                    if (resultsContainer) {
                        resultsContainer.hidden = false;
                        resultsContainer.innerHTML = `<div class="empty-state">${escapeHtml(searchErrorMessage)}</div>`;
                    }
                }
            };

            const openFilterModal = async () => {
                if (!filterModal || modalVisible) return;
                modalVisible = true;
                lastFocusedElement = document.activeElement;
                filterModal.hidden = false;
                requestAnimationFrame(() => filterModal.classList.add('open'));
                document.body.classList.add('modal-open');
                updateFilterButtonExpanded(true);
                await ensureSearchIndex();
                if (searchInput) {
                    requestAnimationFrame(() => searchInput.focus());
                }
            };

            const closeFilterModal = () => {
                if (!filterModal || !modalVisible) return;
                modalVisible = false;
                filterModal.classList.remove('open');
                document.body.classList.remove('modal-open');
                updateFilterButtonExpanded(false);
                setTimeout(() => {
                    if (!modalVisible) {
                        filterModal.hidden = true;
                    }
                }, 160);
                if (lastFocusedElement && typeof lastFocusedElement.focus === 'function') {
                    requestAnimationFrame(() => lastFocusedElement.focus());
                }
            };

            if (filterOpenButtons.length && filterModal) {
                filterOpenButtons.forEach(button => {
                    button.addEventListener('click', async () => {
                        if (modalVisible) {
                            closeFilterModal();
                        } else {
                            await openFilterModal();
                        }
                    });
                });
            }

            if (filterModal) {
                filterModal.addEventListener('click', (event) => {
                    if (event.target === filterModal) {
                        closeFilterModal();
                    }
                });
            }

            if (filterDialog) {
                filterDialog.addEventListener('click', (event) => event.stopPropagation());
            }

            modalDismissElements.forEach(element => {
                element.addEventListener('click', () => closeFilterModal());
            });

            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && modalVisible) {
                    closeFilterModal();
                }
            });

            const ensureFiltersOpen = () => {
                openFilterModal().catch(() => {});
            };

            const renderResults = () => {
                const hasActiveFilters = searchTerm.length > 0 || activeTags.size > 0;
                if (!hasActiveFilters) {
                    updateFilterButtonActive(false);
                    if (resultsContainer) {
                        resultsContainer.hidden = true;
                        resultsContainer.innerHTML = '';
                    }
                    return;
                }

                updateFilterButtonActive(true);
                ensureFiltersOpen();

                const normalizedTerm = searchTerm.toLowerCase();
                const filtered = searchIndex.filter(item => {
                    const matchesTerm = !normalizedTerm || (
                        item.title.toLowerCase().includes(normalizedTerm) ||
                        item.excerpt.toLowerCase().includes(normalizedTerm) ||
                        item.content.toLowerCase().includes(normalizedTerm)
                    );
                    const matchesTags = activeTags.size === 0 || item.tags.some(tag => activeTags.has(tag));
                    return matchesTerm && matchesTags;
                });

                if (!resultsContainer) return;

                resultsContainer.hidden = false;

                if (!filtered.length) {
                    resultsContainer.innerHTML = `<div class="empty-state">${escapeHtml(searchEmptyMessage)}</div>`;
                    return;
                }

                const cards = filtered.map(item => {
                    const chips = [];
                    if (item.category && item.category.url) {
                        chips.push(`<a class="post-chip post-chip-category" href="${escapeHtml(item.category.url)}">${escapeHtml(item.category.name)}</a>`);
                    }
                    if (item.tagLinks && item.tagLinks.length) {
                        item.tagLinks.forEach(tag => {
                            chips.push(`<a class="post-chip" href="${escapeHtml(tag.url)}">${escapeHtml(tag.name)}</a>`);
                        });
                    }
                    const chipsHtml = chips.length ? `<div class=\"post-chips\">${chips.join('')}</div>` : '';
                    const coverHtml = item.coverImage
                        ? `<div class=\"overflow-hidden\"><img src=\"${escapeHtml(item.coverImage)}\" alt=\"${escapeHtml(item.title)}\" class=\"post-image\" loading=\"lazy\" onerror=\"this.onerror=null;this.src='/assets/placeholder.svg';this.classList.add('placeholder');\"></div>`
                        : '';
                    return `
                        <article class="post-card">
                            ${coverHtml}
                            <div class="post-content-area">
                                <h2><a href="${escapeHtml(item.url)}" class="post-title">${escapeHtml(item.title)}</a></h2>
                                <div class="post-meta">
                                    <div class="post-date">
                                        <time datetime="${escapeHtml(item.dateISO)}">${escapeHtml(item.dateFormatted)}</time>
                                    </div>
                                    ${chipsHtml}
                                </div>
                                <div class="post-excerpt">${escapeHtml(item.excerpt)}</div>
                            </div>
                        </article>`;
                }).join('');

                resultsContainer.innerHTML = cards;
            };

            const updateTagButtonStates = () => {
                if (!tagFilter) return;
                const buttons = tagFilter.querySelectorAll('[data-tag]');
                buttons.forEach(button => {
                    const tag = button.dataset.tag;
                    if (!tag) {
                        if (activeTags.size === 0) {
                            button.classList.add('active');
                        } else {
                            button.classList.remove('active');
                        }
                        return;
                    }
                    if (activeTags.has(tag)) {
                        button.classList.add('active');
                    } else {
                        button.classList.remove('active');
                    }
                });
            };

            if (searchInput) {
                searchInput.addEventListener('input', async (event) => {
                    searchTerm = event.target.value.trim();
                    await ensureSearchIndex();
                    renderResults();
                });

                searchInput.addEventListener('keydown', (event) => {
                    if (event.key === 'Escape') {
                        event.stopPropagation();
                        closeFilterModal();
                    }
                });
            }

            if (tagFilter) {
                tagFilter.addEventListener('click', async (event) => {
                    const button = event.target.closest('[data-tag]');
                    if (!button) return;
                    const tag = button.dataset.tag;

                    await ensureSearchIndex();

                    if (!tag) {
                        activeTags.clear();
                    } else if (activeTags.has(tag)) {
                        activeTags.delete(tag);
                    } else {
                        activeTags.add(tag);
                    }

                    updateTagButtonStates();
                    renderResults();
                });
            }
        });
    </script>
    {{#if analytics.bodyEnd}}
    {{{analytics.bodyEnd}}}
    {{/if}}
</body>
</html>
